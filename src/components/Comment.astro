---
const configHTML = `
<script src="https://giscus.app/client.js"
        data-repo="YANXIAOXIH/Fuwari"
        data-repo-id="R_kgDOQToQog"
        data-category="Announcements"
        data-category-id="DIC_kwDOQToQos4CyC6A"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
`;

function extractAttribute(html: string, attr: string): string {
  const regex = new RegExp(`${attr}="([^"]*)"`, 'i');
  const match = html.match(regex);
  return match ? match[1] : '';
}

const config = {
  src: extractAttribute(configHTML, 'src'),
  repo: extractAttribute(configHTML, 'data-repo'),
  repoId: extractAttribute(configHTML, 'data-repo-id'),
  category: extractAttribute(configHTML, 'data-category'),
  categoryId: extractAttribute(configHTML, 'data-category-id'),
  mapping: extractAttribute(configHTML, 'data-mapping') || 'pathname',
  strict: extractAttribute(configHTML, 'data-strict') || '0',
  reactionsEnabled: extractAttribute(configHTML, 'data-reactions-enabled') || '1',
  emitMetadata: extractAttribute(configHTML, 'data-emit-metadata') || '0',
  inputPosition: extractAttribute(configHTML, 'data-input-position') || 'bottom',
  theme: extractAttribute(configHTML, 'data-theme') || 'preferred_color_scheme',
  lang: extractAttribute(configHTML, 'data-lang') || 'zh-CN',
  loading: extractAttribute(configHTML, 'data-loading') || 'lazy'
};
---

<div id="giscus-container"></div>

<script define:vars={{ config }}>
  function getCurrentTheme() {
    if (config.theme !== 'preferred_color_scheme') {
      return config.theme;
    }

    return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
  }

  function loadGiscus() {
    const container = document.getElementById('giscus-container');
    if (!container) return;

    container.innerHTML = '';

    const script = document.createElement('script');
    script.src = config.src || 'https://giscus.app/client.js';
    Object.keys(config).forEach(key => {
        if (key === 'src') return;
    });
    
    script.setAttribute('data-repo', config.repo);
    script.setAttribute('data-repo-id', config.repoId);
    script.setAttribute('data-category', config.category);
    script.setAttribute('data-category-id', config.categoryId);
    script.setAttribute('data-mapping', config.mapping);
    script.setAttribute('data-strict', config.strict);
    script.setAttribute('data-reactions-enabled', config.reactionsEnabled);
    script.setAttribute('data-emit-metadata', config.emitMetadata);
    script.setAttribute('data-input-position', config.inputPosition);
    script.setAttribute('data-theme', getCurrentTheme());
    script.setAttribute('data-lang', config.lang);
    script.setAttribute('data-loading', config.loading);
    script.crossOrigin = 'anonymous';
    script.async = true;

    container.appendChild(script);
  }

  document.addEventListener('astro:page-load', loadGiscus);
  document.addEventListener('DOMContentLoaded', loadGiscus);
</script>